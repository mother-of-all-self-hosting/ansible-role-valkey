# SPDX-FileCopyrightText: 2024, 2025 Slavi Pantaleev
# SPDX-FileCopyrightText: 2025, 2026 Suguru Hirahara
#
# SPDX-License-Identifier: AGPL-3.0-or-later

---
# Project source code URL: https://github.com/valkey-io/valkey

valkey_enabled: true

valkey_identifier: valkey
valkey_base_path: "/{{ valkey_identifier }}"
valkey_config_path: "{{ valkey_base_path }}/config"
valkey_data_path: "{{ valkey_base_path }}/data"

# renovate: datasource=docker depName=valkey/valkey versioning=semver
valkey_version: 9.0.3

valkey_uid: ""
valkey_gid: ""

valkey_container_image: "{{ valkey_container_image_registry_prefix }}valkey/valkey:{{ valkey_container_image_tag }}"
valkey_container_image_tag: "{{ valkey_version }}-alpine"
valkey_container_image_registry_prefix: "{{ valkey_container_image_registry_prefix_upstream }}"
valkey_container_image_registry_prefix_upstream: "{{ valkey_container_image_registry_prefix_upstream_default }}"
valkey_container_image_registry_prefix_upstream_default: docker.io/
valkey_container_image_force_pull: "{{ valkey_container_image.endswith(':latest') }}"

valkey_container_image_self_build: false
valkey_container_image_self_build_name: "valkey-io/valkey-container:{{ valkey_container_image_self_build_repo_version }}"
valkey_container_image_self_build_repo: "https://github.com/valkey-io/valkey-container.git"
valkey_container_image_self_build_repo_version: "mainline"
valkey_container_image_self_build_src_files_path: "{{ valkey_base_path }}/docker-src"
valkey_container_image_self_build_repo_dockerfile_dir: "{{ valkey_container_image_self_build_src_files_path }}/{{ valkey_version.split('.')[0] }}.{{ valkey_version.split('.')[1] }}/alpine" # where Dockerfile and docker-entrypoint.sh exist

# The base container network. It will be auto-created by this role if it doesn't exist already.
valkey_container_network: "{{ valkey_identifier }}"

# Control if the container network is deleted on uninstalling.
valkey_container_network_deletion_enabled: true

# Specify how the container publishes its TCP port (as defined by `valkey_container_tcp_port`).
#
# Takes an "<ip>:<port>" or "<port>" value (e.g. "127.0.0.1:2586"), or empty string to not expose.
valkey_container_tcp_host_bind_port: ""

# The port number in the container
valkey_container_tcp_port: 6379

# A list of additional container networks that the container would be connected to.
# The role does not create these networks, so make sure they already exist.
valkey_container_additional_networks: "{{ (valkey_container_additional_networks_default + valkey_container_additional_networks_auto + valkey_container_additional_networks_custom) | unique }}"
valkey_container_additional_networks_default: []
valkey_container_additional_networks_auto: []
valkey_container_additional_networks_custom: []

# Controls how long to wait for the container to stop gracefully before killing it.
# Because `devture_systemd_docker_base_container_stop_grace_time_seconds` may be quite short and databases are more important to stop gracefully,
# we default to at least 30 seconds.
valkey_container_stop_grace_time_seconds: "{{ [devture_systemd_docker_base_container_stop_grace_time_seconds, 30] | max }}"

# Controls how long the pre-start cleanup should wait for stale container-name release
# before failing startup explicitly.
valkey_container_cleanup_timeout_seconds: "{{ devture_systemd_docker_base_container_cleanup_timeout_seconds }}"

# Controls the delay between pre-start cleanup retries.
valkey_container_cleanup_retry_delay_seconds: "{{ devture_systemd_docker_base_container_cleanup_retry_delay_seconds }}"

# Shell command used in the systemd pre-start phase to deterministically remove a stale
# container and wait until Docker releases its name.
valkey_container_cleanup_command: |
  i=0;
  while [ "$i" -lt {{ valkey_container_cleanup_timeout_seconds }} ]; do
  {{ devture_systemd_docker_base_host_command_docker }} stop -t {{ valkey_container_stop_grace_time_seconds }} {{ valkey_identifier }} >/dev/null 2>&1 || true;
  {{ devture_systemd_docker_base_host_command_docker }} rm -f {{ valkey_identifier }} >/dev/null 2>&1 || true;
  if {{ devture_systemd_docker_base_host_command_docker }} container inspect {{ valkey_identifier }} >/dev/null 2>&1; then
  i=$((i + 1));
  sleep {{ valkey_container_cleanup_retry_delay_seconds }};
  continue;
  fi;
  if {{ devture_systemd_docker_base_host_command_docker }} info >/dev/null 2>&1; then
  exit 0;
  fi;
  echo "Failed to query Docker daemon while cleaning up {{ valkey_identifier }}" >&2;
  exit 1;
  done;
  echo "Failed to remove stale container {{ valkey_identifier }} after {{ valkey_container_cleanup_timeout_seconds }} attempts" >&2;
  exit 1

# Specify the size of the container's tmpfs volume
valkey_container_tmpfs_tmp_size: 128m

# A list of extra arguments to pass to the container (`docker create` command)
valkey_container_extra_arguments: "{{ valkey_container_extra_arguments_auto + valkey_container_extra_arguments_custom }}"
valkey_container_extra_arguments_auto: []
valkey_container_extra_arguments_custom: []

# List of systemd services that the Valkey systemd service depends on
valkey_systemd_required_services_list: "{{ (valkey_systemd_required_services_list_default + valkey_systemd_required_services_list_auto + valkey_systemd_required_services_list_custom) | unique }}"
valkey_systemd_required_services_list_default: "{{ [devture_systemd_docker_base_docker_service_name] if devture_systemd_docker_base_docker_service_name else [] }}"
valkey_systemd_required_services_list_auto: []
valkey_systemd_required_services_list_custom: []

# List of systemd services that the Valkey systemd service wants
valkey_systemd_wanted_services_list: "{{ (valkey_systemd_wanted_services_list_default + valkey_systemd_wanted_services_list_auto + valkey_systemd_wanted_services_list_custom) | unique }}"
valkey_systemd_wanted_services_list_default: []
valkey_systemd_wanted_services_list_auto: []
valkey_systemd_wanted_services_list_custom: []

valkey_connection_password: ""

valkey_arch: x86_64

# Specify the timezone
valkey_environment_variables_tz: UTC

# Additional environment variables.
valkey_environment_variables_additional_variables: ""

# valkey_restart_necessary controls whether the Valkey systemd
# service will be restarted (when true) or merely started (when false) by the
# systemd service manager role (when conditional restart is enabled).
#
# This value is automatically computed during installation based on whether
# any configuration files, the systemd service file, or the container image changed.
# The default of `false` means "no restart needed" â€” appropriate when the role's
# installation tasks haven't run (e.g., due to --tags skipping them).
valkey_restart_necessary: false
